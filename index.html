<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Contador de Tempo sem Problemas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f2f2f2;
      padding: 40px;
    }

    h1 {
      margin-bottom: 30px;
    }

    .container {
      display: flex;
      justify-content: center;
      gap: 50px;
    }

    .contador {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 280px;
    }

    .tempo {
      font-size: 32px;
      margin: 10px 0;
      color: #2e7d32;
    }

    .problemas {
      font-size: 16px;
      color: #d32f2f;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #d32f2f;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #b71c1c;
    }

    .reset-geral {
      margin-bottom: 30px;
      background-color: #444;
    }

    .caveira {
      font-size: 40px;
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Tempo sem Problemas em cada escritÃ³rio</h1>
  <!-- ATENÃ‡ÃƒO: O reset geral com senha no frontend NÃƒO Ã‰ SEGURO! Veja as notas abaixo. -->
  <button onclick="resetarTudo()" class="reset-geral">
    ðŸ”„ Resetar Tudo
  </button>

  <div class="container">
    <div class="contador">
      <h2>Filial RJ</h2>
      <div class="tempo" id="tempo-rj">--d --h --m --s</div> <!-- Placeholder inicial -->
      <div class="problemas" id="problemas-rj">Problemas: --</div> <!-- Placeholder inicial -->
      <button onclick="resetar('rj')">Problema no RJ</button>
      <div id="caveira-rj" class="caveira">ðŸ’€</div>
    </div>
    <div class="contador">
      <h2>Filial SP</h2>
      <div class="tempo" id="tempo-sp">--d --h --m --s</div> <!-- Placeholder inicial -->
      <div class="problemas" id="problemas-sp">Problemas: --</div> <!-- Placeholder inicial -->
      <button onclick="resetar('sp')">Problema em SP</button>
      <div id="caveira-sp" class="caveira">ðŸ’€</div>
    </div>
  </div>

  <!-- Adicione os scripts do Firebase AQUI -->
  <script type="module">
    // Importe as funÃ§Ãµes necessÃ¡rias dos mÃ³dulos do Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Sua configuraÃ§Ã£o do Firebase (PEGUE OS VALORES EXATOS DO SEU CONSOLE DO PROJETO contador-4b1ad)
    // VÃ¡ em ConfiguraÃ§Ãµes do Projeto -> Seus apps -> Selecione ou adicione um app Web
    const firebaseConfig = {
      apiKey: "SUA_API_KEY_AQUI", // SUBSTITUA!
      authDomain: "contador-4b1ad.firebaseapp.com", // Pode variar um pouco
      projectId: "contador-4b1ad",
      storageBucket: "contador-4b1ad.appspot.com", // Pode variar
      messagingSenderId: "SEU_SENDER_ID_AQUI", // SUBSTITUA!
      appId: "SEU_APP_ID_AQUI" // Formato geralmente "1:PROJECT_NUMBER:web:...", SUBSTITUA!
      // databaseURL: "https://contador-4b1ad.firebaseio.com" // Se usasse Realtime Database, estaria aqui
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);

    // Pega a instÃ¢ncia do Firestore
    const db = getFirestore(app);

    // ReferÃªncia para o documento no Firestore onde vamos guardar os dados globais
    // Usaremos um documento Ãºnico na coleÃ§Ã£o 'status' chamado 'global'
    const statusDocRef = doc(db, "status", "global");

    // VariÃ¡veis locais para guardar os dados do Firestore
    let statusData = {
        rj: { startTime: Timestamp.now(), problemas: 0 }, // Valores padrÃ£o caso o documento nÃ£o exista ainda
        sp: { startTime: Timestamp.now(), problemas: 0 }
    };

    // FunÃ§Ã£o para formatar o tempo (mantida do seu cÃ³digo)
    function formatarTempo(ms) {
      const totalSegundos = Math.floor(ms / 1000);
      const dias = Math.floor(totalSegundos / 86400);
      const horas = Math.floor((totalSegundos % 86400) / 3600);
      const minutos = Math.floor((totalSegundos % 3600) / 60);
      const segundos = totalSegundos % 60;

      return `${dias.toString().padStart(2, '0')}d `
           + `${horas.toString().padStart(2, '0')}h `
           + `${minutos.toString().padStart(2, '0')}m `
           + `${segundos.toString().padStart(2, '0')}s`;
    }

    // FunÃ§Ã£o para ATUALIZAR O DISPLAY no HTML usando os dados globais
    // Esta funÃ§Ã£o serÃ¡ chamada a cada segundo (pelo setInterval)
    function atualizarDisplay() {
      const agora = Date.now();

      // Calcula o tempo decorrido usando o startTime GLOBAL do statusData
      const tempoRj = agora - statusData.rj.startTime.toDate().getTime(); // Firestore Timestamp precisa ser convertido para Date e depois para ms
      const tempoSp = agora - statusData.sp.startTime.toDate().getTime();

      // Exibe os tempos formatados
      document.getElementById("tempo-rj").textContent = formatarTempo(tempoRj);
      document.getElementById("tempo-sp").textContent = formatarTempo(tempoSp);

      // Exibe as contagens de problemas globais
      document.getElementById("problemas-rj").textContent = `Problemas: ${statusData.rj.problemas}`;
      document.getElementById("problemas-sp").textContent = `Problemas: ${statusData.sp.problemas}`;
    }

    // --- Listener em tempo real do Firestore ---
    // Esta Ã© a parte crucial para a sincronizaÃ§Ã£o global!
    // Quando o documento "status/global" mudar no Firestore, esta funÃ§Ã£o serÃ¡ executada.
    onSnapshot(statusDocRef, (docSnapshot) => {
      if (docSnapshot.exists()) {
        console.log("Dados globais recebidos do Firestore:", docSnapshot.data());
        const data = docSnapshot.data();

        // Atualiza as variÃ¡veis locais com os novos dados do Firestore
        // Assegura que startTime Ã© um Timestamp (Firestore geralmente garante isso para campos desse tipo)
        statusData.rj = {
            startTime: data.rj?.startTime instanceof Timestamp ? data.rj.startTime : Timestamp.now(),
            problemas: typeof data.rj?.problemas === 'number' ? data.rj.problemas : 0
        };
        statusData.sp = {
            startTime: data.sp?.startTime instanceof Timestamp ? data.sp.startTime : Timestamp.now(),
            problemas: typeof data.sp?.problemas === 'number' ? data.sp.problemas : 0
        };

        // A primeira vez que os dados chegam, ou quando eles mudam,
        // o display Ã© atualizado imediatamente com a hora de inÃ­cio correta.
        atualizarDisplay();

      } else {
        // O documento ainda nÃ£o existe. Crie-o com valores iniciais.
        console.log("Documento 'status/global' nÃ£o encontrado no Firestore. Criando...");
        const initialData = {
            rj: { startTime: Timestamp.now(), problemas: 0 },
            sp: { startTime: Timestamp.now(), problemas: 0 }
        };
        setDoc(statusDocRef, initialData)
            .then(() => {
                console.log("Documento 'status/global' criado com sucesso.");
                 // A criaÃ§Ã£o do documento vai acionar o onSnapshot novamente com os dados existentes,
                 // entÃ£o nÃ£o precisamos chamar atualizarDisplay() aqui.
            })
            .catch((error) => {
                console.error("Erro ao criar documento 'status/global':", error);
                // Tratar erro na criaÃ§Ã£o
            });
      }
    }, (error) => {
        console.error("Erro no listener do Firestore:", error);
        // Tratar erros de conexÃ£o ou permissÃ£o aqui
        document.getElementById("tempo-rj").textContent = "Erro!";
        document.getElementById("tempo-sp").textContent = "Erro!";
        document.getElementById("problemas-rj").textContent = "Erro!";
        document.getElementById("problemas-sp").textContent = "Erro!";
    });


    // --- FunÃ§Ãµes para resetar (AGORA ESCREVENDO NO FIRESTORE) ---

    // FunÃ§Ã£o para resetar uma filial especÃ­fica
    // Esta funÃ§Ã£o ATUALIZA o documento no Firestore
    async function resetar(filial) {
      console.log(`Problema reportado na filial ${filial}. Resetando...`);
      const caveira = document.getElementById(`caveira-${filial}`);

      try {
        // Atualiza o campo de startTime da filial e incrementa a contagem de problemas no Firestore
        await updateDoc(statusDocRef, {
          [`${filial}.startTime`]: Timestamp.now(), // Define o novo timestamp para a filial
          [`${filial}.problemas`]: increment(1)    // Incrementa a contagem de problemas
        });
        console.log(`Status da filial ${filial} atualizado no Firestore.`);

        // A exibiÃ§Ã£o da caveira continua local no frontend, o reset Ã© global
         if (caveira) {
            caveira.style.display = "block";
            setTimeout(() => {
              caveira.style.display = "none";
            }, 2000);
          }

        // NÃƒO precisamos chamar atualizarDisplay() aqui, pois o onSnapshot
        // serÃ¡ acionado automaticamente pela mudanÃ§a no Firestore e chamarÃ¡ atualizarDisplay()
        // com os dados mais recentes.

      } catch (error) {
        console.error(`Erro ao resetar filial ${filial} no Firestore:`, error);
        alert(`Erro ao reportar problema para ${filial}. Verifique o console.`);
        // Tratar o erro no frontend
      }
    }
    // Torna a funÃ§Ã£o resetar globalmente acessÃ­vel para o onclick no HTML
    window.resetar = resetar;


    // FunÃ§Ã£o para reset
